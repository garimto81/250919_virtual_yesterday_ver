<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Apps Script v62 로컬 테스트</title>
    <script src="https://cdn-tailwindcss.vercel.app/"></script>
    <style>
        .console-output {
            background: #1e1e1e;
            color: #f0f0f0;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            padding: 15px;
            border-radius: 5px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .test-section {
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
        }
        .success { color: #10b981; }
        .error { color: #ef4444; }
        .info { color: #3b82f6; }
        .warning { color: #f59e0b; }
    </style>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto p-6">
        <h1 class="text-3xl font-bold text-center mb-8">
            🧪 Apps Script v62 로컬 테스트 환경
        </h1>

        <!-- 테스트 컨트롤 -->
        <div class="test-section bg-white">
            <h2 class="text-xl font-semibold mb-4">🎮 테스트 실행</h2>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <button onclick="runBasicTests()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                    기본 기능 테스트
                </button>
                <button onclick="runBatchUpdateTest()" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                    일괄 업데이트 테스트
                </button>
                <button onclick="runDeleteTest()" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">
                    삭제 기능 테스트
                </button>
                <button onclick="runSortTest()" class="bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-600">
                    정렬 기능 테스트
                </button>
            </div>
            <div class="mt-4">
                <button onclick="clearOutput()" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">
                    출력 지우기
                </button>
                <button onclick="printCurrentData()" class="bg-yellow-500 text-white px-4 py-2 rounded hover:bg-yellow-600">
                    현재 데이터 출력
                </button>
                <button onclick="resetTestData()" class="bg-orange-500 text-white px-4 py-2 rounded hover:bg-orange-600">
                    테스트 데이터 리셋
                </button>
            </div>
        </div>

        <!-- 테스트 결과 출력 -->
        <div class="test-section bg-white">
            <h2 class="text-xl font-semibold mb-4">📋 테스트 결과</h2>
            <div id="test-output" class="console-output">
                테스트 출력이 여기에 표시됩니다...
            </div>
        </div>

        <!-- 현재 데이터 표시 -->
        <div class="test-section bg-white">
            <h2 class="text-xl font-semibold mb-4">📊 현재 Type 시트 데이터</h2>
            <div id="data-display" class="overflow-x-auto">
                <table class="min-w-full table-auto border-collapse border border-gray-300">
                    <thead>
                        <tr class="bg-gray-50">
                            <th class="border border-gray-300 px-4 py-2">행</th>
                            <th class="border border-gray-300 px-4 py-2">Camera</th>
                            <th class="border border-gray-300 px-4 py-2">Player</th>
                            <th class="border border-gray-300 px-4 py-2">Table</th>
                            <th class="border border-gray-300 px-4 py-2">Notable</th>
                            <th class="border border-gray-300 px-4 py-2">Chips</th>
                            <th class="border border-gray-300 px-4 py-2">UpdatedAt</th>
                            <th class="border border-gray-300 px-4 py-2">Seat</th>
                            <th class="border border-gray-300 px-4 py-2">Status</th>
                        </tr>
                    </thead>
                    <tbody id="data-table-body">
                        <!-- 데이터가 여기에 표시됩니다 -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- 대화형 테스트 -->
        <div class="test-section bg-white">
            <h2 class="text-xl font-semibold mb-4">🔧 대화형 테스트</h2>
            <div class="space-y-4">
                <!-- 플레이어 추가 -->
                <div class="p-4 bg-blue-50 rounded">
                    <h3 class="font-semibold mb-2">플레이어 추가</h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                        <input type="text" id="add-player-name" placeholder="플레이어 이름" class="border rounded px-2 py-1">
                        <input type="text" id="add-player-table" placeholder="테이블" class="border rounded px-2 py-1">
                        <input type="number" id="add-player-seat" placeholder="좌석" class="border rounded px-2 py-1">
                        <input type="number" id="add-player-chips" placeholder="칩" class="border rounded px-2 py-1">
                    </div>
                    <button onclick="addPlayerInteractive()" class="mt-2 bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                        플레이어 추가
                    </button>
                </div>

                <!-- 플레이어 삭제 -->
                <div class="p-4 bg-red-50 rounded">
                    <h3 class="font-semibold mb-2">플레이어 삭제</h3>
                    <div class="grid grid-cols-2 gap-2">
                        <input type="text" id="delete-player-name" placeholder="플레이어 이름" class="border rounded px-2 py-1">
                        <input type="text" id="delete-player-table" placeholder="테이블" class="border rounded px-2 py-1">
                    </div>
                    <button onclick="deletePlayerInteractive()" class="mt-2 bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">
                        플레이어 삭제
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Mock 환경 및 Apps Script 로드 -->
    <script src="mock-apps-script.js"></script>
    <script src="local-apps-script.js"></script>

    <script>
        // 콘솔 출력을 웹페이지로 리다이렉트
        const originalConsoleLog = console.log;
        const originalConsoleError = console.error;
        const originalConsoleWarn = console.warn;

        let outputBuffer = [];

        function logToPage(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const colorClass = type === 'error' ? 'error' : type === 'warning' ? 'warning' : type === 'success' ? 'success' : 'info';
            outputBuffer.push(`<span class="${colorClass}">[${timestamp}] ${message}</span>`);

            const outputElement = document.getElementById('test-output');
            if (outputElement) {
                outputElement.innerHTML = outputBuffer.join('\n');
                outputElement.scrollTop = outputElement.scrollHeight;
            }
        }

        console.log = function(...args) {
            const message = args.map(arg => typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)).join(' ');
            logToPage(message, 'info');
            originalConsoleLog.apply(console, args);
        };

        console.error = function(...args) {
            const message = args.map(arg => typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)).join(' ');
            logToPage(message, 'error');
            originalConsoleError.apply(console, args);
        };

        console.warn = function(...args) {
            const message = args.map(arg => typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)).join(' ');
            logToPage(message, 'warning');
            originalConsoleWarn.apply(console, args);
        };

        // 테스트 함수들
        function clearOutput() {
            outputBuffer = [];
            document.getElementById('test-output').innerHTML = '출력이 지워졌습니다.';
        }

        function resetTestData() {
            console.log('=== 테스트 데이터 리셋 ===');
            TestUtils.resetTestData();
            console.log('테스트 데이터가 초기화되었습니다.');
            updateDataDisplay();
        }

        function printCurrentData() {
            console.log('=== 현재 Type 시트 데이터 ===');
            TestUtils.printSheetData('Type');
            updateDataDisplay();
        }

        function updateDataDisplay() {
            const data = TestUtils.getSheetData('Type');
            const tbody = document.getElementById('data-table-body');

            tbody.innerHTML = '';

            data.forEach((row, index) => {
                const tr = document.createElement('tr');
                tr.className = index === 0 ? 'bg-gray-100 font-semibold' : index % 2 === 0 ? 'bg-gray-50' : '';

                const rowCell = document.createElement('td');
                rowCell.className = 'border border-gray-300 px-4 py-2 text-center';
                rowCell.textContent = index + 1;
                tr.appendChild(rowCell);

                row.forEach(cell => {
                    const td = document.createElement('td');
                    td.className = 'border border-gray-300 px-4 py-2';
                    td.textContent = cell instanceof Date ? cell.toLocaleString() : String(cell);
                    tr.appendChild(td);
                });

                tbody.appendChild(tr);
            });
        }

        function runBasicTests() {
            console.log('🧪 기본 기능 테스트 시작');

            try {
                // 1. 테이블 목록 조회
                console.log('\n1️⃣ 테이블 목록 조회 테스트');
                const tableList = getTableList();
                console.log('결과:', tableList);

                // 2. 특정 테이블 플레이어 조회
                console.log('\n2️⃣ Table1 플레이어 조회 테스트');
                const players = getPlayersByTable('Table1');
                console.log('결과:', players);

                // 3. 새 플레이어 추가
                console.log('\n3️⃣ 새 플레이어 추가 테스트');
                const addResult = addPlayer({
                    name: 'TestPlayer',
                    table: 'TestTable',
                    seat: 5,
                    chips: 50000
                });
                console.log('결과:', addResult);

                console.log('\n✅ 기본 기능 테스트 완료');
                updateDataDisplay();

            } catch (error) {
                console.error('❌ 기본 기능 테스트 중 오류:', error);
            }
        }

        function runBatchUpdateTest() {
            console.log('🧪 일괄 업데이트 테스트 시작');

            try {
                const players = [
                    { name: 'BatchPlayer1', seat: 1, chips: 10000, notable: false },
                    { name: 'BatchPlayer2', seat: 2, chips: 15000, notable: true },
                    { name: 'BatchPlayer3', seat: 3, chips: 8000, notable: false }
                ];

                const deleted = ['Player4']; // OUT 상태 플레이어 삭제

                console.log('일괄 업데이트 요청 데이터:');
                console.log('플레이어:', players);
                console.log('삭제 대상:', deleted);

                const result = batchUpdatePlayers('TestBatch', players, deleted);
                console.log('일괄 업데이트 결과:', result);

                console.log('\n✅ 일괄 업데이트 테스트 완료');
                updateDataDisplay();

            } catch (error) {
                console.error('❌ 일괄 업데이트 테스트 중 오류:', error);
            }
        }

        function runDeleteTest() {
            console.log('🧪 삭제 기능 테스트 시작');

            try {
                // 먼저 삭제할 플레이어 추가
                console.log('1️⃣ 삭제할 플레이어 추가');
                const addResult = addPlayer({
                    name: 'DeleteMe',
                    table: 'DeleteTest',
                    seat: 1,
                    chips: 1000
                });
                console.log('추가 결과:', addResult);

                // 플레이어 삭제
                console.log('\n2️⃣ 플레이어 삭제');
                const deleteResult = deletePlayer('DeleteMe', 'DeleteTest');
                console.log('삭제 결과:', deleteResult);

                console.log('\n✅ 삭제 기능 테스트 완료');
                updateDataDisplay();

            } catch (error) {
                console.error('❌ 삭제 기능 테스트 중 오류:', error);
            }
        }

        function runSortTest() {
            console.log('🧪 정렬 기능 테스트 시작');

            try {
                // 정렬 전 데이터 확인
                console.log('정렬 전 데이터:');
                TestUtils.printSheetData('Type');

                // 정렬 실행
                console.log('\n정렬 실행...');
                const sortResult = sortTypeSheet();
                console.log('정렬 결과:', sortResult ? '성공' : '실패');

                // 정렬 후 데이터 확인
                console.log('\n정렬 후 데이터:');
                TestUtils.printSheetData('Type');

                console.log('\n✅ 정렬 기능 테스트 완료');
                updateDataDisplay();

            } catch (error) {
                console.error('❌ 정렬 기능 테스트 중 오류:', error);
            }
        }

        function addPlayerInteractive() {
            const name = document.getElementById('add-player-name').value;
            const table = document.getElementById('add-player-table').value;
            const seat = document.getElementById('add-player-seat').value;
            const chips = document.getElementById('add-player-chips').value;

            if (!name || !table) {
                console.error('플레이어 이름과 테이블은 필수입니다.');
                return;
            }

            console.log(`🔧 대화형 플레이어 추가: ${name}`);
            const result = addPlayer({
                name: name,
                table: table,
                seat: seat ? parseInt(seat) : null,
                chips: chips ? parseInt(chips) : 0
            });

            console.log('추가 결과:', result);
            updateDataDisplay();

            // 입력 필드 초기화
            document.getElementById('add-player-name').value = '';
            document.getElementById('add-player-table').value = '';
            document.getElementById('add-player-seat').value = '';
            document.getElementById('add-player-chips').value = '';
        }

        function deletePlayerInteractive() {
            const name = document.getElementById('delete-player-name').value;
            const table = document.getElementById('delete-player-table').value;

            if (!name || !table) {
                console.error('플레이어 이름과 테이블은 필수입니다.');
                return;
            }

            console.log(`🔧 대화형 플레이어 삭제: ${name}`);
            const result = deletePlayer(name, table);

            console.log('삭제 결과:', result);
            updateDataDisplay();

            // 입력 필드 초기화
            document.getElementById('delete-player-name').value = '';
            document.getElementById('delete-player-table').value = '';
        }

        // 페이지 로드 시 초기 데이터 표시
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 Apps Script v62 로컬 테스트 환경이 준비되었습니다!');
            console.log('왼쪽 버튼들을 클릭하여 테스트를 시작하세요.');
            updateDataDisplay();
        });
    </script>
</body>
</html>