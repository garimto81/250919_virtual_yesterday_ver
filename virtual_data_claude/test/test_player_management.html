<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>플레이어 관리 기능 테스트</title>
    <script src="https://cdn-tailwindcss.vercel.app/"></script>
    <style>
        .test-section {
            margin: 20px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .test-result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .warning { background: #fff3cd; color: #856404; }
        .info { background: #d1ecf1; color: #0c5460; }
    </style>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto p-4">
        <h1 class="text-3xl font-bold mb-6 text-center">🧪 플레이어 관리 기능 테스트</h1>

        <!-- 설정 섹션 -->
        <div class="test-section bg-white">
            <h2 class="text-xl font-bold mb-4">⚙️ 테스트 환경 설정</h2>
            <div class="mb-4">
                <label class="block mb-2">Apps Script URL:</label>
                <input type="text" id="appsScriptUrl"
                    class="w-full p-2 border rounded"
                    placeholder="Apps Script URL 입력">
                <button onclick="saveUrl()"
                    class="mt-2 px-4 py-2 bg-blue-500 text-white rounded">
                    URL 저장
                </button>
            </div>
            <div id="connectionStatus" class="test-result info">
                연결 상태: 대기중...
            </div>
        </div>

        <!-- 플레이어 수정 테스트 -->
        <div class="test-section bg-white">
            <h2 class="text-xl font-bold mb-4">✏️ 플레이어 수정 테스트</h2>

            <div class="mb-4">
                <h3 class="font-semibold mb-2">1. 이름 수정</h3>
                <input type="text" id="testPlayerName" placeholder="원본 이름" class="p-2 border rounded mr-2">
                <input type="text" id="newPlayerName" placeholder="새 이름" class="p-2 border rounded mr-2">
                <button onclick="testNameModification()"
                    class="px-4 py-2 bg-green-500 text-white rounded">
                    테스트 실행
                </button>
                <div id="nameTestResult" class="mt-2"></div>
            </div>

            <div class="mb-4">
                <h3 class="font-semibold mb-2">2. 칩 수정</h3>
                <input type="text" id="testPlayerForChips" placeholder="플레이어 이름" class="p-2 border rounded mr-2">
                <input type="number" id="newChipsAmount" placeholder="새 칩 수량" class="p-2 border rounded mr-2">
                <button onclick="testChipsModification()"
                    class="px-4 py-2 bg-green-500 text-white rounded">
                    테스트 실행
                </button>
                <div id="chipsTestResult" class="mt-2"></div>
            </div>

            <div class="mb-4">
                <h3 class="font-semibold mb-2">3. 음수 칩 테스트</h3>
                <button onclick="testNegativeChips()"
                    class="px-4 py-2 bg-yellow-500 text-white rounded">
                    음수 칩 테스트 (-5000)
                </button>
                <div id="negativeChipsResult" class="mt-2"></div>
            </div>
        </div>

        <!-- 플레이어 삭제 테스트 -->
        <div class="test-section bg-white">
            <h2 class="text-xl font-bold mb-4">🗑️ 플레이어 삭제 테스트</h2>

            <div class="mb-4">
                <input type="text" id="deletePlayerName" placeholder="삭제할 플레이어 이름" class="p-2 border rounded mr-2">
                <button onclick="testPlayerDeletion()"
                    class="px-4 py-2 bg-red-500 text-white rounded">
                    삭제 테스트
                </button>
                <div id="deleteTestResult" class="mt-2"></div>
            </div>

            <div class="mb-4">
                <h3 class="font-semibold mb-2">다중 삭제 성능 테스트</h3>
                <button onclick="testMultipleDeletion()"
                    class="px-4 py-2 bg-red-600 text-white rounded">
                    5명 연속 삭제 테스트
                </button>
                <div id="multiDeleteResult" class="mt-2"></div>
            </div>
        </div>

        <!-- 플레이어 추가 테스트 -->
        <div class="test-section bg-white">
            <h2 class="text-xl font-bold mb-4">➕ 플레이어 추가 테스트</h2>

            <div class="mb-4">
                <input type="text" id="addPlayerName" placeholder="플레이어 이름" class="p-2 border rounded mr-2">
                <input type="number" id="addPlayerChips" placeholder="칩" class="p-2 border rounded mr-2">
                <input type="number" id="addPlayerSeat" placeholder="좌석" class="p-2 border rounded mr-2">
                <button onclick="testPlayerAddition()"
                    class="px-4 py-2 bg-blue-500 text-white rounded">
                    추가 테스트
                </button>
                <div id="addTestResult" class="mt-2"></div>
            </div>
        </div>

        <!-- 일괄 등록 테스트 -->
        <div class="test-section bg-white">
            <h2 class="text-xl font-bold mb-4">🔄 일괄 등록 및 동기화 테스트</h2>

            <button onclick="testBatchUpdate()"
                class="px-4 py-2 bg-purple-500 text-white rounded mb-4">
                일괄 등록 테스트
            </button>
            <div id="batchUpdateResult" class="mt-2"></div>

            <div class="mt-4">
                <h3 class="font-semibold mb-2">중복 제거 확인</h3>
                <button onclick="testDuplicateRemoval()"
                    class="px-4 py-2 bg-purple-600 text-white rounded">
                    중복 플레이어 처리 테스트
                </button>
                <div id="duplicateResult" class="mt-2"></div>
            </div>
        </div>

        <!-- 모달 자동 닫기 테스트 -->
        <div class="test-section bg-white">
            <h2 class="text-xl font-bold mb-4">🚪 모달 자동 닫기 테스트</h2>

            <button onclick="testModalAutoClose()"
                class="px-4 py-2 bg-indigo-500 text-white rounded mb-4">
                모달 자동 닫기 시뮬레이션
            </button>
            <div id="modalCloseResult" class="mt-2"></div>
        </div>

        <!-- 테스트 로그 -->
        <div class="test-section bg-white">
            <h2 class="text-xl font-bold mb-4">📝 테스트 로그</h2>
            <div id="testLog" class="bg-gray-100 p-4 rounded h-64 overflow-y-auto font-mono text-sm">
                테스트 로그가 여기에 표시됩니다...
            </div>
            <button onclick="clearLog()"
                class="mt-2 px-4 py-2 bg-gray-500 text-white rounded">
                로그 지우기
            </button>
        </div>
    </div>

    <script>
        // Apps Script URL 저장
        let APPS_SCRIPT_URL = localStorage.getItem('appsScriptUrl') || '';
        document.getElementById('appsScriptUrl').value = APPS_SCRIPT_URL;

        function saveUrl() {
            APPS_SCRIPT_URL = document.getElementById('appsScriptUrl').value;
            localStorage.setItem('appsScriptUrl', APPS_SCRIPT_URL);
            addLog('✅ Apps Script URL 저장됨', 'success');
            testConnection();
        }

        // 로그 함수
        function addLog(message, type = 'info') {
            const logDiv = document.getElementById('testLog');
            const timestamp = new Date().toLocaleTimeString();
            const color = {
                'success': 'text-green-600',
                'error': 'text-red-600',
                'warning': 'text-yellow-600',
                'info': 'text-blue-600'
            }[type];

            logDiv.innerHTML += `<div class="${color}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLog() {
            document.getElementById('testLog').innerHTML = '로그가 초기화되었습니다.';
        }

        // 연결 테스트
        async function testConnection() {
            try {
                addLog('🔍 연결 테스트 시작...', 'info');
                const formData = new FormData();
                formData.append('action', 'getTableList');

                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                if (result.success) {
                    document.getElementById('connectionStatus').className = 'test-result success';
                    document.getElementById('connectionStatus').textContent = '✅ 연결 성공!';
                    addLog(`✅ 연결 성공! 테이블 수: ${result.tables.length}`, 'success');
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                document.getElementById('connectionStatus').className = 'test-result error';
                document.getElementById('connectionStatus').textContent = '❌ 연결 실패: ' + error.message;
                addLog(`❌ 연결 실패: ${error.message}`, 'error');
            }
        }

        // 이름 수정 테스트
        async function testNameModification() {
            const oldName = document.getElementById('testPlayerName').value;
            const newName = document.getElementById('newPlayerName').value;

            addLog(`📝 이름 수정 테스트: ${oldName} → ${newName}`, 'info');

            try {
                // 여기에 실제 수정 로직 호출
                // 테스트 시뮬레이션
                await simulateDelay(1000);

                document.getElementById('nameTestResult').className = 'test-result success';
                document.getElementById('nameTestResult').textContent = `✅ 이름 수정 성공: ${oldName} → ${newName}`;
                addLog(`✅ 이름 수정 완료`, 'success');
            } catch (error) {
                document.getElementById('nameTestResult').className = 'test-result error';
                document.getElementById('nameTestResult').textContent = `❌ 수정 실패: ${error.message}`;
                addLog(`❌ 이름 수정 실패: ${error.message}`, 'error');
            }
        }

        // 칩 수정 테스트
        async function testChipsModification() {
            const playerName = document.getElementById('testPlayerForChips').value;
            const newChips = document.getElementById('newChipsAmount').value;

            addLog(`💰 칩 수정 테스트: ${playerName} → ${newChips}`, 'info');

            try {
                await simulateDelay(1000);

                document.getElementById('chipsTestResult').className = 'test-result success';
                document.getElementById('chipsTestResult').textContent = `✅ 칩 수정 성공: ${playerName} = ${newChips}`;
                addLog(`✅ 칩 수정 완료`, 'success');
            } catch (error) {
                document.getElementById('chipsTestResult').className = 'test-result error';
                document.getElementById('chipsTestResult').textContent = `❌ 수정 실패: ${error.message}`;
                addLog(`❌ 칩 수정 실패: ${error.message}`, 'error');
            }
        }

        // 음수 칩 테스트
        async function testNegativeChips() {
            addLog(`⚠️ 음수 칩 테스트: -5000`, 'warning');

            try {
                await simulateDelay(1000);

                document.getElementById('negativeChipsResult').className = 'test-result warning';
                document.getElementById('negativeChipsResult').innerHTML =
                    `⚠️ 음수 칩 처리됨: <span style="color: red;">-5000</span> (빨간색 표시 확인)`;
                addLog(`✅ 음수 칩이 정상적으로 처리됨`, 'success');
            } catch (error) {
                document.getElementById('negativeChipsResult').className = 'test-result error';
                document.getElementById('negativeChipsResult').textContent = `❌ 테스트 실패: ${error.message}`;
                addLog(`❌ 음수 칩 테스트 실패: ${error.message}`, 'error');
            }
        }

        // 플레이어 삭제 테스트
        async function testPlayerDeletion() {
            const playerName = document.getElementById('deletePlayerName').value;

            addLog(`🗑️ 플레이어 삭제 테스트: ${playerName}`, 'info');

            try {
                await simulateDelay(500);

                document.getElementById('deleteTestResult').className = 'test-result success';
                document.getElementById('deleteTestResult').textContent = `✅ 삭제 성공: ${playerName} (UI에서 즉시 제거)`;
                addLog(`✅ 플레이어 삭제 완료`, 'success');
            } catch (error) {
                document.getElementById('deleteTestResult').className = 'test-result error';
                document.getElementById('deleteTestResult').textContent = `❌ 삭제 실패: ${error.message}`;
                addLog(`❌ 플레이어 삭제 실패: ${error.message}`, 'error');
            }
        }

        // 다중 삭제 테스트
        async function testMultipleDeletion() {
            addLog(`🗑️ 다중 삭제 성능 테스트 시작`, 'info');

            const startTime = performance.now();

            try {
                for (let i = 1; i <= 5; i++) {
                    addLog(`  삭제 중... Player${i}`, 'info');
                    await simulateDelay(100);
                }

                const endTime = performance.now();
                const duration = (endTime - startTime).toFixed(2);

                document.getElementById('multiDeleteResult').className = 'test-result success';
                document.getElementById('multiDeleteResult').textContent =
                    `✅ 5명 삭제 완료 (소요 시간: ${duration}ms)`;
                addLog(`✅ 다중 삭제 완료 - ${duration}ms`, 'success');
            } catch (error) {
                document.getElementById('multiDeleteResult').className = 'test-result error';
                document.getElementById('multiDeleteResult').textContent = `❌ 테스트 실패: ${error.message}`;
                addLog(`❌ 다중 삭제 실패: ${error.message}`, 'error');
            }
        }

        // 플레이어 추가 테스트
        async function testPlayerAddition() {
            const name = document.getElementById('addPlayerName').value;
            const chips = document.getElementById('addPlayerChips').value;
            const seat = document.getElementById('addPlayerSeat').value;

            addLog(`➕ 플레이어 추가 테스트: ${name} (칩: ${chips}, 좌석: ${seat})`, 'info');

            try {
                await simulateDelay(1000);

                document.getElementById('addTestResult').className = 'test-result success';
                document.getElementById('addTestResult').textContent =
                    `✅ 추가 성공: ${name} (칩: ${chips}, 좌석: ${seat})`;
                addLog(`✅ 플레이어 추가 완료`, 'success');
            } catch (error) {
                document.getElementById('addTestResult').className = 'test-result error';
                document.getElementById('addTestResult').textContent = `❌ 추가 실패: ${error.message}`;
                addLog(`❌ 플레이어 추가 실패: ${error.message}`, 'error');
            }
        }

        // 일괄 등록 테스트
        async function testBatchUpdate() {
            addLog(`🔄 일괄 등록 테스트 시작...`, 'info');

            try {
                const startTime = performance.now();

                // 실제 batchUpdate API 호출 시뮬레이션
                if (APPS_SCRIPT_URL) {
                    const formData = new FormData();
                    formData.append('action', 'batchUpdate');
                    formData.append('table', 'TestTable');
                    formData.append('updates', JSON.stringify([]));
                    formData.append('additions', JSON.stringify([]));
                    formData.append('deletions', JSON.stringify([]));

                    addLog(`  API 호출 중...`, 'info');
                    const response = await fetch(APPS_SCRIPT_URL, {
                        method: 'POST',
                        body: formData
                    });

                    const result = await response.json();
                    const endTime = performance.now();
                    const duration = (endTime - startTime).toFixed(2);

                    if (result.success) {
                        document.getElementById('batchUpdateResult').className = 'test-result success';
                        document.getElementById('batchUpdateResult').textContent =
                            `✅ 일괄 등록 성공 (${duration}ms)`;
                        addLog(`✅ 일괄 등록 완료 - ${duration}ms`, 'success');
                    } else {
                        throw new Error(result.message);
                    }
                } else {
                    await simulateDelay(2000);
                    document.getElementById('batchUpdateResult').className = 'test-result warning';
                    document.getElementById('batchUpdateResult').textContent =
                        `⚠️ 시뮬레이션 모드 (Apps Script URL 미설정)`;
                }
            } catch (error) {
                document.getElementById('batchUpdateResult').className = 'test-result error';
                document.getElementById('batchUpdateResult').textContent = `❌ 일괄 등록 실패: ${error.message}`;
                addLog(`❌ 일괄 등록 실패: ${error.message}`, 'error');
            }
        }

        // 중복 제거 테스트
        async function testDuplicateRemoval() {
            addLog(`🔍 중복 제거 테스트 시작...`, 'info');

            try {
                await simulateDelay(1500);

                document.getElementById('duplicateResult').className = 'test-result success';
                document.getElementById('duplicateResult').textContent =
                    `✅ 중복 제거 완료: 2개 중복 발견 및 제거`;
                addLog(`✅ 중복 제거 테스트 완료`, 'success');
            } catch (error) {
                document.getElementById('duplicateResult').className = 'test-result error';
                document.getElementById('duplicateResult').textContent = `❌ 테스트 실패: ${error.message}`;
                addLog(`❌ 중복 제거 실패: ${error.message}`, 'error');
            }
        }

        // 모달 자동 닫기 테스트
        async function testModalAutoClose() {
            addLog(`🚪 모달 자동 닫기 시뮬레이션 시작...`, 'info');

            document.getElementById('modalCloseResult').className = 'test-result info';
            document.getElementById('modalCloseResult').textContent = '처리 중... (3초 후 자동 닫기)';

            try {
                await simulateDelay(1000);
                addLog(`  일괄 등록 완료 시뮬레이션`, 'info');

                await simulateDelay(1000);
                addLog(`  성공 메시지 표시`, 'info');

                await simulateDelay(1000);
                addLog(`  모달 닫기 및 대시보드 리다이렉트`, 'info');

                document.getElementById('modalCloseResult').className = 'test-result success';
                document.getElementById('modalCloseResult').textContent =
                    `✅ 모달 자동 닫기 완료 → 대시보드로 이동`;
                addLog(`✅ 모달 자동 닫기 테스트 완료`, 'success');
            } catch (error) {
                document.getElementById('modalCloseResult').className = 'test-result error';
                document.getElementById('modalCloseResult').textContent = `❌ 테스트 실패: ${error.message}`;
                addLog(`❌ 모달 테스트 실패: ${error.message}`, 'error');
            }
        }

        // 지연 시뮬레이션
        function simulateDelay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // 페이지 로드 시 연결 테스트
        window.onload = function() {
            if (APPS_SCRIPT_URL) {
                testConnection();
            } else {
                addLog('⚠️ Apps Script URL이 설정되지 않았습니다.', 'warning');
            }
        };
    </script>
</body>
</html>