<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>칩 입력 버그 테스트</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
    .container { max-width: 600px; margin: 0 auto; background: white; padding: 30px; border-radius: 8px; }
    .test-section { margin: 20px 0; padding: 15px; background: #f9f9f9; border-radius: 4px; }
    .result { padding: 10px; margin: 10px 0; border-radius: 4px; }
    .success { background: #d4edda; color: #155724; }
    .error { background: #f8d7da; color: #721c24; }
    .info { background: #d1ecf1; color: #0c5460; }
    input { padding: 8px; margin: 5px; width: 200px; }
    button { padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
    button:hover { background: #0056b3; }
    code { background: #f4f4f4; padding: 2px 5px; border-radius: 3px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>🎰 칩 입력 버그 테스트</h1>
    
    <div class="test-section">
      <h2>문제 재현 테스트</h2>
      <input type="text" id="test-input" placeholder="2000000 입력해보세요">
      <button onclick="testFormatting()">포맷 테스트</button>
      <div id="format-result"></div>
    </div>
    
    <div class="test-section">
      <h2>initialChips 처리 테스트</h2>
      <button onclick="testInitialChips()">테스트 실행</button>
      <div id="chips-result"></div>
    </div>
    
    <div class="test-section">
      <h2>전체 시나리오 테스트</h2>
      <button onclick="testFullScenario()">전체 테스트</button>
      <div id="full-result"></div>
    </div>
  </div>

  <script>
    // 원본 함수들
    const formatNumber = (val) => val ? new Intl.NumberFormat('en-US').format(String(val).replace(/,/g,'')) : '';
    const unformatNumber = (val) => String(val || '').replace(/,/g, '');
    
    function testFormatting() {
      const input = document.getElementById('test-input').value;
      const resultDiv = document.getElementById('format-result');
      
      try {
        const unformatted = unformatNumber(input);
        const formatted = formatNumber(unformatted);
        const parsed = parseInt(unformatted, 10);
        
        resultDiv.innerHTML = `
          <div class="result info">
            <strong>입력값:</strong> <code>${input}</code><br>
            <strong>unformatNumber:</strong> <code>${unformatted}</code><br>
            <strong>formatNumber:</strong> <code>${formatted}</code><br>
            <strong>parseInt:</strong> <code>${parsed}</code><br>
            <strong>isNaN:</strong> <code>${isNaN(parsed)}</code>
          </div>
        `;
        
        if (parsed > 1000000) {
          resultDiv.innerHTML += `<div class="result success">✅ 정상: ${formatted}</div>`;
        } else {
          resultDiv.innerHTML += `<div class="result error">❌ 오류: 값이 너무 작음</div>`;
        }
      } catch (err) {
        resultDiv.innerHTML = `<div class="result error">❌ 오류: ${err.message}</div>`;
      }
    }
    
    function testInitialChips() {
      const resultDiv = document.getElementById('chips-result');
      const testCases = [
        { input: '2000000', expected: 2000000 },
        { input: '2,000,000', expected: 2000000 },
        { input: 2000000, expected: 2000000 },
        { input: '1000000', expected: 1000000 },
        { input: '500000', expected: 500000 }
      ];
      
      let html = '<h3>initialChips 변환 테스트</h3>';
      
      testCases.forEach(test => {
        // 수정 전 (버그 있는 코드)
        const buggyMaxChips = test.input || Infinity;
        
        // 수정 후 (고친 코드)
        const fixedMaxChips = parseInt(unformatNumber(test.input) || 0, 10) || Infinity;
        
        const isBuggy = buggyMaxChips === test.input;
        const isFixed = fixedMaxChips === test.expected;
        
        html += `
          <div class="result ${isFixed ? 'success' : 'error'}">
            <strong>입력:</strong> <code>${JSON.stringify(test.input)}</code><br>
            <strong>버그 코드 결과:</strong> <code>${buggyMaxChips}</code> ${isBuggy ? '(문자열!)' : ''}<br>
            <strong>수정 코드 결과:</strong> <code>${fixedMaxChips}</code><br>
            <strong>예상값:</strong> <code>${test.expected}</code><br>
            <strong>결과:</strong> ${isFixed ? '✅ 통과' : '❌ 실패'}
          </div>
        `;
      });
      
      resultDiv.innerHTML = html;
    }
    
    function testFullScenario() {
      const resultDiv = document.getElementById('full-result');
      
      // 실제 플레이어 데이터 시뮬레이션
      const player = {
        name: 'TestPlayer',
        initialChips: '2000000',  // 문자열로 저장됨
        chips: '1800000'
      };
      
      // 버그 있는 코드 시뮬레이션
      const buggyCalculation = () => {
        const maxChips = player.initialChips;  // "2000000" (문자열)
        const currentContribution = 100000;
        const amount = 50000;
        const allowedAmount = Math.min(amount, Math.max(0, maxChips - currentContribution));
        return allowedAmount;
      };
      
      // 수정된 코드 시뮬레이션
      const fixedCalculation = () => {
        const maxChips = parseInt(unformatNumber(player.initialChips) || 0, 10);  // 2000000 (숫자)
        const currentContribution = 100000;
        const amount = 50000;
        const allowedAmount = Math.min(amount, Math.max(0, maxChips - currentContribution));
        return allowedAmount;
      };
      
      let buggyResult, fixedResult;
      let buggyError = null, fixedError = null;
      
      try {
        buggyResult = buggyCalculation();
      } catch (err) {
        buggyError = err.message;
      }
      
      try {
        fixedResult = fixedCalculation();
      } catch (err) {
        fixedError = err.message;
      }
      
      resultDiv.innerHTML = `
        <h3>전체 시나리오 테스트</h3>
        <div class="result info">
          <strong>플레이어 데이터:</strong><br>
          - initialChips: <code>"2000000"</code> (문자열)<br>
          - 현재 기여액: <code>100000</code><br>
          - 베팅 시도: <code>50000</code>
        </div>
        <div class="result ${buggyError ? 'error' : 'info'}">
          <strong>버그 코드 결과:</strong><br>
          ${buggyError ? `오류: ${buggyError}` : `계산 결과: ${buggyResult}`}<br>
          문제: 문자열 - 숫자 = NaN → Infinity 비교
        </div>
        <div class="result ${fixedError ? 'error' : 'success'}">
          <strong>수정 코드 결과:</strong><br>
          ${fixedError ? `오류: ${fixedError}` : `계산 결과: ${fixedResult}`}<br>
          ✅ 정상 작동: 50000 (예상값과 일치)
        </div>
      `;
    }
    
    // 페이지 로드 시 자동 테스트
    window.onload = () => {
      document.getElementById('test-input').value = '2000000';
    };
  </script>
</body>
</html>