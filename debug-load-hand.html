<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>핸드 불러오기 디버깅</title>
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; background: #1a1a1a; color: white; padding: 20px; }
        .section { background: #333; border-radius: 8px; padding: 15px; margin: 20px 0; }
        h2 { color: #fbbf24; }
        .log { background: #222; padding: 10px; border-radius: 4px; margin: 10px 0; font-family: monospace; }
        .success { color: #10b981; }
        .error { color: #ef4444; }
        .info { color: #3b82f6; }
        button { background: #4b5563; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; margin: 5px; }
        button:hover { background: #6b7280; }
        pre { background: #111; padding: 10px; border-radius: 4px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>🔍 핸드 불러오기 기능 디버깅</h1>
    
    <div class="section">
        <h2>1. 상태 확인</h2>
        <button onclick="checkState()">상태 체크</button>
        <div id="state-log" class="log"></div>
    </div>
    
    <div class="section">
        <h2>2. CSV 데이터 확인</h2>
        <button onclick="checkCSV()">CSV 로드 테스트</button>
        <div id="csv-log" class="log"></div>
    </div>
    
    <div class="section">
        <h2>3. Index 데이터 확인</h2>
        <button onclick="checkIndex()">Index 데이터 확인</button>
        <div id="index-log" class="log"></div>
    </div>
    
    <div class="section">
        <h2>4. 핸드 불러오기 테스트</h2>
        <input type="number" id="hand-number" placeholder="핸드 번호" value="1">
        <button onclick="testLoadHand()">핸드 불러오기 테스트</button>
        <div id="load-log" class="log"></div>
    </div>
    
    <div class="section">
        <h2>5. 모달 테스트</h2>
        <button onclick="testModal()">모달 열기 테스트</button>
        <div id="modal-log" class="log"></div>
    </div>
    
    <button onclick="location.href='index.html'">메인으로 돌아가기</button>
    
    <script>
        // 전역 상태 시뮬레이션
        const state = {
            indexRows: [],
            handCsvCache: null,
            playersInHand: [],
            board: [],
            playerStatus: {},
            actionState: {
                handNumber: '',
                smallBlind: '',
                bigBlind: '',
                hasBBAnte: false,
                preflop: [],
                flop: [],
                turn: [],
                river: []
            }
        };
        
        function log(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info';
            element.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
        }
        
        async function checkState() {
            log('state-log', '현재 상태 확인 중...', 'info');
            
            // localStorage 체크
            const savedState = localStorage.getItem('pokerHandLoggerState');
            if(savedState) {
                log('state-log', '✅ localStorage에 저장된 상태 발견', 'success');
                const parsed = JSON.parse(savedState);
                log('state-log', `핸드 번호: ${parsed.actionState?.handNumber || '없음'}`, 'info');
            } else {
                log('state-log', '❌ localStorage에 저장된 상태 없음', 'error');
            }
            
            // 실제 페이지의 요소 확인
            log('state-log', 'DOM 요소 확인...', 'info');
            const loadBtn = document.getElementById('load-hand-btn');
            const modal = document.getElementById('load-hand-modal');
            
            if(loadBtn) {
                log('state-log', '✅ Load 버튼 존재', 'success');
            } else {
                log('state-log', '❌ Load 버튼 없음', 'error');
            }
            
            if(modal) {
                log('state-log', '✅ Load Modal 존재', 'success');
            } else {
                log('state-log', '❌ Load Modal 없음', 'error');
            }
        }
        
        async function checkCSV() {
            log('csv-log', 'CSV 로드 시작...', 'info');
            
            try {
                // Hand CSV URL (예시 - 실제 URL로 교체 필요)
                const CSV_HAND_URL = 'https://docs.google.com/spreadsheets/d/YOUR_SHEET_ID/gviz/tq?tqx=out:csv&sheet=Hand';
                
                log('csv-log', `URL: ${CSV_HAND_URL}`, 'info');
                
                // 실제로는 fetchCsv 함수를 사용
                const response = await fetch(CSV_HAND_URL + `&cb=${Date.now()}`);
                
                if(response.ok) {
                    const text = await response.text();
                    const lines = text.split('\n').length;
                    log('csv-log', `✅ CSV 로드 성공: ${lines} 행`, 'success');
                    
                    // 첫 몇 줄 표시
                    const preview = text.split('\n').slice(0, 5).join('\n');
                    log('csv-log', `<pre>${preview}</pre>`, 'info');
                } else {
                    log('csv-log', `❌ CSV 로드 실패: ${response.status}`, 'error');
                }
            } catch(err) {
                log('csv-log', `❌ 오류: ${err.message}`, 'error');
                log('csv-log', 'CSV URL을 확인하고 CORS 설정을 점검하세요.', 'info');
            }
        }
        
        async function checkIndex() {
            log('index-log', 'Index 데이터 확인...', 'info');
            
            try {
                // Index CSV URL (예시)
                const CSV_INDEX_URL = 'https://docs.google.com/spreadsheets/d/YOUR_SHEET_ID/gviz/tq?tqx=out:csv&sheet=Index';
                
                const response = await fetch(CSV_INDEX_URL + `&cb=${Date.now()}`);
                
                if(response.ok) {
                    const text = await response.text();
                    const lines = text.split('\n');
                    
                    log('index-log', `✅ Index 로드 성공: ${lines.length} 행`, 'success');
                    
                    // 파싱 시뮬레이션
                    const headers = lines[0].split(',');
                    log('index-log', `헤더: ${headers.slice(0, 5).join(', ')}...`, 'info');
                    
                    // 최근 핸드 몇 개 표시
                    const recentHands = lines.slice(1, 4).map(line => {
                        const cols = line.split(',');
                        return `핸드 #${cols[0]}: ${cols[7]} (${cols[16]})`;
                    });
                    
                    recentHands.forEach(hand => {
                        log('index-log', hand, 'info');
                    });
                } else {
                    log('index-log', `❌ Index 로드 실패: ${response.status}`, 'error');
                }
            } catch(err) {
                log('index-log', `❌ 오류: ${err.message}`, 'error');
            }
        }
        
        async function testLoadHand() {
            const handNumber = document.getElementById('hand-number').value;
            log('load-log', `핸드 #${handNumber} 불러오기 테스트...`, 'info');
            
            try {
                // parseHandBlock 시뮬레이션
                log('load-log', '1. Hand CSV에서 해당 핸드 검색 중...', 'info');
                
                // 실제로는 parseHandBlock 함수 사용
                const mockData = {
                    handNumber: handNumber,
                    smallBlind: '50',
                    bigBlind: '100',
                    ante: 0,
                    table: 'Table 1',
                    players: [
                        { name: 'Player1', seat: 1, initialChips: '1000', finalChips: '1200', hand: ['As', 'Kd'] },
                        { name: 'Player2', seat: 2, initialChips: '1000', finalChips: '800', hand: ['Qh', 'Qc'] }
                    ],
                    board: ['Ah', '7d', '2c', 'Js', '9h'],
                    actions: {
                        preflop: [
                            { player: 'Player1', action: 'Raises', amount: '300' },
                            { player: 'Player2', action: 'Calls', amount: '300' }
                        ],
                        flop: [],
                        turn: [],
                        river: []
                    }
                };
                
                log('load-log', '2. 데이터 파싱 완료', 'success');
                log('load-log', `<pre>${JSON.stringify(mockData, null, 2)}</pre>`, 'info');
                
                // 상태 업데이트 시뮬레이션
                log('load-log', '3. 상태 업데이트 중...', 'info');
                state.playersInHand = mockData.players;
                state.board = mockData.board;
                state.actionState.handNumber = mockData.handNumber;
                
                log('load-log', '✅ 핸드 불러오기 성공!', 'success');
                
            } catch(err) {
                log('load-log', `❌ 오류: ${err.message}`, 'error');
            }
        }
        
        function testModal() {
            log('modal-log', '모달 테스트 시작...', 'info');
            
            // 간단한 모달 생성
            const modalHtml = `
                <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); 
                            background: #444; padding: 20px; border-radius: 8px; z-index: 1000;">
                    <h3>테스트 모달</h3>
                    <p>모달이 정상적으로 열렸습니다!</p>
                    <button onclick="this.parentElement.remove()">닫기</button>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            log('modal-log', '✅ 모달 생성 완료', 'success');
        }
        
        // 페이지 로드 시 초기 체크
        window.onload = () => {
            log('state-log', '페이지 로드 완료', 'success');
            checkState();
        };
    </script>
</body>
</html>