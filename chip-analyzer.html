<!DOCTYPE html>
<!--
  ============================================
  포커 핸드 로거 with AI 칩 분석 (Poker Hand Logger with AI Chip Analysis)
  Version: 2.2.0
  Last Modified: 2025-01-05
  
  New Features:
  - 칩 컬러 등록 시스템 (최대 5개)
  - AI 기반 칩 스택 분석 (Gemini API)
  - 다중 사진 촬영 및 분석
  ============================================
-->
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0" />
  <title>포커 핸드 로거 v2.2.0 (AI 칩 분석)</title>
  <script src="https://cdn-tailwindcss.vercel.app/"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@700&family=Noto+Sans+KR:wght@400;500;700&display=swap');
    html, body { height: 100vh; overflow: hidden; font-family: 'Noto Sans KR', sans-serif; }
    #app-container { display: flex; flex-direction: column; height: 100%; }
    main { flex-grow: 1; overflow-y: auto; }
    .chip-color-sample { width: 40px; height: 40px; border-radius: 50%; border: 2px solid #ccc; cursor: pointer; position: relative; }
    .chip-color-sample.selected { border: 3px solid #fbbf24; }
    .chip-image-preview { width: 80px; height: 80px; object-fit: cover; border-radius: 8px; }
    .analyzing-overlay { background: rgba(0,0,0,0.8); backdrop-filter: blur(4px); }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    .pulse-animation { animation: pulse 2s infinite; }
  </style>
</head>
<body class="bg-gray-900 text-white">
  <div id="app-container">
    <!-- 헤더 -->
    <div class="bg-gray-900 border-b border-gray-700 px-3 py-2">
      <div class="flex justify-between items-center">
        <span class="font-bold text-amber-400">포커 핸드 로거 AI</span>
        <span class="text-gray-400 text-sm">v2.2.0</span>
      </div>
    </div>

    <main class="p-4 space-y-4">
      <!-- 칩 컬러 등록 섹션 -->
      <div class="bg-gray-800 p-4 rounded-lg">
        <h2 class="text-lg font-bold mb-3 text-amber-400">칩 컬러 등록</h2>
        <div class="flex gap-3 items-center flex-wrap">
          <div id="chip-colors-container" class="flex gap-2">
            <!-- 칩 컬러 슬롯들이 여기 동적으로 추가됨 -->
          </div>
          <button id="add-chip-color-btn" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg text-sm font-medium">
            + 칩 추가
          </button>
        </div>
        <div id="chip-values-container" class="mt-3 space-y-2 hidden">
          <!-- 칩 값 입력 필드들이 여기 동적으로 추가됨 -->
        </div>
      </div>

      <!-- 플레이어 칩 스택 분석 섹션 -->
      <div class="bg-gray-800 p-4 rounded-lg">
        <h2 class="text-lg font-bold mb-3 text-amber-400">플레이어 칩 스택</h2>
        <div id="players-chip-analysis" class="space-y-3">
          <!-- 플레이어별 칩 분석 버튼들이 여기 동적으로 추가됨 -->
        </div>
      </div>

      <!-- 분석 결과 표시 -->
      <div id="analysis-results" class="bg-gray-800 p-4 rounded-lg hidden">
        <h2 class="text-lg font-bold mb-3 text-green-400">분석 결과</h2>
        <div id="results-content" class="space-y-2">
          <!-- 분석 결과가 여기 표시됨 -->
        </div>
      </div>
    </main>
  </div>

  <!-- 칩 컬러 촬영 모달 -->
  <div id="chip-color-modal" class="fixed inset-0 bg-black bg-opacity-75 hidden z-50">
    <div class="flex items-center justify-center h-full p-4">
      <div class="bg-gray-800 rounded-lg p-4 max-w-md w-full">
        <h3 class="text-lg font-bold mb-3">칩 사진 촬영</h3>
        <video id="chip-video" class="w-full rounded-lg mb-3" autoplay playsinline></video>
        <canvas id="chip-canvas" class="hidden"></canvas>
        <div class="flex gap-2">
          <button id="capture-chip-btn" class="flex-1 bg-green-600 hover:bg-green-700 py-2 rounded-lg font-medium">
            촬영
          </button>
          <button id="close-chip-modal" class="flex-1 bg-gray-600 hover:bg-gray-700 py-2 rounded-lg font-medium">
            취소
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- 칩 스택 분석 모달 -->
  <div id="stack-analysis-modal" class="fixed inset-0 bg-black bg-opacity-75 hidden z-50">
    <div class="flex items-center justify-center h-full p-4">
      <div class="bg-gray-800 rounded-lg p-4 max-w-lg w-full max-h-[90vh] overflow-y-auto">
        <h3 class="text-lg font-bold mb-3">
          <span id="analyzing-player-name">플레이어</span> 칩 스택 분석
        </h3>
        
        <div id="stack-images-container" class="grid grid-cols-2 gap-2 mb-3">
          <!-- 촬영된 이미지들이 여기 표시됨 -->
        </div>
        
        <video id="stack-video" class="w-full rounded-lg mb-3" autoplay playsinline></video>
        <canvas id="stack-canvas" class="hidden"></canvas>
        
        <div class="flex gap-2 mb-3">
          <button id="capture-stack-btn" class="flex-1 bg-blue-600 hover:bg-blue-700 py-2 rounded-lg font-medium">
            사진 추가
          </button>
          <button id="analyze-stack-btn" class="flex-1 bg-green-600 hover:bg-green-700 py-2 rounded-lg font-medium" disabled>
            AI 분석 시작
          </button>
        </div>
        
        <button id="close-stack-modal" class="w-full bg-gray-600 hover:bg-gray-700 py-2 rounded-lg font-medium">
          닫기
        </button>
      </div>
    </div>
  </div>

  <!-- AI 분석 중 오버레이 -->
  <div id="analyzing-overlay" class="fixed inset-0 analyzing-overlay hidden z-[60]">
    <div class="flex items-center justify-center h-full">
      <div class="bg-gray-900 rounded-lg p-6 text-center">
        <div class="text-3xl mb-3 pulse-animation">🤖</div>
        <p class="text-lg font-medium mb-2">AI 분석 중...</p>
        <p class="text-sm text-gray-400">칩 스택을 분석하고 있습니다</p>
      </div>
    </div>
  </div>

  <script>
    // Gemini API 설정
    const GEMINI_API_KEY = 'AIzaSyBB8uqP1ECTe40jknSy5XK71TCs8_KbGV0';
    const GEMINI_API_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent';

    // 앱 상태 관리
    const chipState = {
      chipColors: [], // 등록된 칩 컬러 정보 [{color: '#fff', value: 1000, image: 'base64...'}]
      maxChips: 5,
      currentChipSlot: null,
      playerStacks: {}, // {playerName: {images: [], estimatedStack: 0}}
      currentAnalyzingPlayer: null,
      stackImages: [] // 현재 촬영 중인 스택 이미지들
    };

    // 예시 플레이어 데이터 (실제 앱에서는 기존 상태에서 가져옴)
    const samplePlayers = [
      { name: 'Player A', seat: 1, chips: 0 },
      { name: 'Player B', seat: 2, chips: 0 },
      { name: 'Player C', seat: 3, chips: 0 },
      { name: 'Player D', seat: 4, chips: 0 }
    ];

    // 초기화
    function initChipAnalyzer() {
      console.log('칩 분석기 초기화 v2.2.0');
      
      // 칩 컬러 슬롯 렌더링
      renderChipColorSlots();
      
      // 플레이어 칩 분석 버튼 렌더링
      renderPlayerChipButtons();
      
      // 이벤트 리스너 설정
      setupEventListeners();
      
      // localStorage에서 저장된 칩 컬러 로드
      loadSavedChipColors();
    }

    // 칩 컬러 슬롯 렌더링
    function renderChipColorSlots() {
      const container = document.getElementById('chip-colors-container');
      container.innerHTML = '';
      
      for (let i = 0; i < chipState.maxChips; i++) {
        const chip = chipState.chipColors[i];
        const slot = document.createElement('div');
        slot.className = 'chip-color-sample flex items-center justify-center';
        slot.dataset.slot = i;
        
        if (chip) {
          slot.style.backgroundColor = chip.color;
          if (chip.image) {
            slot.style.backgroundImage = `url(${chip.image})`;
            slot.style.backgroundSize = 'cover';
          }
          slot.innerHTML = `<span class="text-white text-xs font-bold">${chip.value}</span>`;
        } else {
          slot.classList.add('bg-gray-700');
          slot.innerHTML = '<span class="text-gray-500">+</span>';
        }
        
        slot.addEventListener('click', () => selectChipSlot(i));
        container.appendChild(slot);
      }
      
      // 칩 값 입력 필드 업데이트
      if (chipState.chipColors.length > 0) {
        renderChipValueInputs();
      }
    }

    // 칩 값 입력 필드 렌더링
    function renderChipValueInputs() {
      const container = document.getElementById('chip-values-container');
      container.innerHTML = '';
      container.classList.remove('hidden');
      
      chipState.chipColors.forEach((chip, index) => {
        const div = document.createElement('div');
        div.className = 'flex items-center gap-2';
        div.innerHTML = `
          <div class="w-6 h-6 rounded-full" style="background-color: ${chip.color}"></div>
          <input type="text" 
            class="bg-gray-700 px-2 py-1 rounded text-sm flex-1" 
            placeholder="칩 값 (예: 1000)"
            value="${chip.value || ''}"
            data-index="${index}">
          <button class="text-red-500 hover:text-red-400 text-sm" data-remove="${index}">삭제</button>
        `;
        container.appendChild(div);
      });
      
      // 값 변경 이벤트
      container.querySelectorAll('input').forEach(input => {
        input.addEventListener('input', (e) => {
          const index = parseInt(e.target.dataset.index);
          const value = parseInt(e.target.value.replace(/\D/g, '')) || 0;
          chipState.chipColors[index].value = value;
          saveChipColors();
          renderChipColorSlots();
        });
      });
      
      // 삭제 버튼 이벤트
      container.querySelectorAll('[data-remove]').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const index = parseInt(e.target.dataset.remove);
          chipState.chipColors.splice(index, 1);
          saveChipColors();
          renderChipColorSlots();
        });
      });
    }

    // 플레이어 칩 분석 버튼 렌더링
    function renderPlayerChipButtons() {
      const container = document.getElementById('players-chip-analysis');
      container.innerHTML = '';
      
      samplePlayers.forEach(player => {
        const div = document.createElement('div');
        div.className = 'flex items-center justify-between bg-gray-700 p-3 rounded-lg';
        
        const stack = chipState.playerStacks[player.name];
        const estimatedChips = stack?.estimatedStack || player.chips || 0;
        
        div.innerHTML = `
          <div>
            <span class="font-medium">${player.name}</span>
            <span class="text-sm text-gray-400 ml-2">Seat ${player.seat}</span>
          </div>
          <div class="flex items-center gap-3">
            <span class="text-amber-400 font-medium">
              ${estimatedChips ? estimatedChips.toLocaleString() : '미분석'}
            </span>
            <button class="bg-purple-600 hover:bg-purple-700 px-3 py-1 rounded text-sm font-medium"
              data-player="${player.name}">
              📷 칩 분석
            </button>
          </div>
        `;
        
        container.appendChild(div);
      });
      
      // 분석 버튼 이벤트
      container.querySelectorAll('[data-player]').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const playerName = e.target.dataset.player;
          openStackAnalysisModal(playerName);
        });
      });
    }

    // 칩 슬롯 선택
    function selectChipSlot(slotIndex) {
      chipState.currentChipSlot = slotIndex;
      openChipColorModal();
    }

    // 칩 컬러 촬영 모달 열기
    async function openChipColorModal() {
      const modal = document.getElementById('chip-color-modal');
      modal.classList.remove('hidden');
      
      try {
        const video = document.getElementById('chip-video');
        const stream = await navigator.mediaDevices.getUserMedia({ 
          video: { facingMode: 'environment' } 
        });
        video.srcObject = stream;
      } catch (err) {
        console.error('카메라 접근 실패:', err);
        alert('카메라를 사용할 수 없습니다.');
      }
    }

    // 칩 사진 촬영
    function captureChipPhoto() {
      const video = document.getElementById('chip-video');
      const canvas = document.getElementById('chip-canvas');
      const context = canvas.getContext('2d');
      
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      context.drawImage(video, 0, 0);
      
      const imageData = canvas.toDataURL('image/jpeg', 0.8);
      
      // 중앙 색상 추출 (간단한 구현)
      const centerX = Math.floor(canvas.width / 2);
      const centerY = Math.floor(canvas.height / 2);
      const pixel = context.getImageData(centerX, centerY, 1, 1).data;
      const color = `rgb(${pixel[0]}, ${pixel[1]}, ${pixel[2]})`;
      
      // 칩 정보 저장
      if (chipState.currentChipSlot !== null) {
        if (!chipState.chipColors[chipState.currentChipSlot]) {
          chipState.chipColors[chipState.currentChipSlot] = {};
        }
        chipState.chipColors[chipState.currentChipSlot].color = color;
        chipState.chipColors[chipState.currentChipSlot].image = imageData;
        chipState.chipColors[chipState.currentChipSlot].value = chipState.chipColors[chipState.currentChipSlot].value || 0;
        
        saveChipColors();
        renderChipColorSlots();
        closeChipColorModal();
      }
    }

    // 칩 컬러 모달 닫기
    function closeChipColorModal() {
      const modal = document.getElementById('chip-color-modal');
      const video = document.getElementById('chip-video');
      
      if (video.srcObject) {
        video.srcObject.getTracks().forEach(track => track.stop());
      }
      
      modal.classList.add('hidden');
      chipState.currentChipSlot = null;
    }

    // 스택 분석 모달 열기
    async function openStackAnalysisModal(playerName) {
      chipState.currentAnalyzingPlayer = playerName;
      chipState.stackImages = [];
      
      const modal = document.getElementById('stack-analysis-modal');
      document.getElementById('analyzing-player-name').textContent = playerName;
      document.getElementById('stack-images-container').innerHTML = '';
      document.getElementById('analyze-stack-btn').disabled = true;
      
      modal.classList.remove('hidden');
      
      try {
        const video = document.getElementById('stack-video');
        const stream = await navigator.mediaDevices.getUserMedia({ 
          video: { facingMode: 'environment' } 
        });
        video.srcObject = stream;
      } catch (err) {
        console.error('카메라 접근 실패:', err);
        alert('카메라를 사용할 수 없습니다.');
      }
    }

    // 스택 사진 촬영
    function captureStackPhoto() {
      const video = document.getElementById('stack-video');
      const canvas = document.getElementById('stack-canvas');
      const context = canvas.getContext('2d');
      
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      context.drawImage(video, 0, 0);
      
      const imageData = canvas.toDataURL('image/jpeg', 0.8);
      chipState.stackImages.push(imageData);
      
      // 이미지 프리뷰 추가
      const container = document.getElementById('stack-images-container');
      const img = document.createElement('img');
      img.src = imageData;
      img.className = 'chip-image-preview border-2 border-gray-600';
      container.appendChild(img);
      
      // 분석 버튼 활성화
      if (chipState.stackImages.length > 0) {
        document.getElementById('analyze-stack-btn').disabled = false;
      }
    }

    // AI 칩 스택 분석
    async function analyzeChipStack() {
      if (chipState.stackImages.length === 0) {
        alert('먼저 사진을 촬영해주세요.');
        return;
      }
      
      // 분석 중 오버레이 표시
      document.getElementById('analyzing-overlay').classList.remove('hidden');
      
      try {
        // 칩 컬러 정보 준비
        const chipInfo = chipState.chipColors
          .filter(c => c && c.value)
          .map(c => `값 ${c.value}: ${c.color}`)
          .join(', ');
        
        // Gemini API 호출을 위한 이미지 준비
        const imageParts = chipState.stackImages.map(imageData => ({
          inline_data: {
            mime_type: "image/jpeg",
            data: imageData.split(',')[1] // base64 부분만 추출
          }
        }));
        
        // Gemini API 요청
        const response = await fetch(`${GEMINI_API_URL}?key=${GEMINI_API_KEY}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            contents: [{
              parts: [
                {
                  text: `이 포커 칩 스택 사진들을 분석해주세요. 
                  등록된 칩 정보: ${chipInfo || '칩 정보 없음'}
                  
                  다음 형식으로 응답해주세요:
                  1. 보이는 칩의 개수와 색상별 분포
                  2. 대략적인 총 칩 개수 추정
                  3. 총 칩 가치 추정 (등록된 칩 정보 기반)
                  
                  숫자만 간단명료하게 답변해주세요.`
                },
                ...imageParts
              ]
            }],
            generationConfig: {
              temperature: 0.2,
              topK: 32,
              topP: 1,
              maxOutputTokens: 1024,
            }
          })
        });
        
        const data = await response.json();
        console.log('Gemini API 응답:', data);
        
        if (data.candidates && data.candidates[0]) {
          const analysisText = data.candidates[0].content.parts[0].text;
          
          // 숫자 추출 (간단한 파싱)
          const numberMatch = analysisText.match(/[\d,]+(?:\s*만)?(?:\s*천)?/g);
          let estimatedValue = 0;
          
          if (numberMatch) {
            const lastNumber = numberMatch[numberMatch.length - 1];
            estimatedValue = parseKoreanNumber(lastNumber);
          }
          
          // 결과 저장
          if (!chipState.playerStacks[chipState.currentAnalyzingPlayer]) {
            chipState.playerStacks[chipState.currentAnalyzingPlayer] = {};
          }
          chipState.playerStacks[chipState.currentAnalyzingPlayer].images = [...chipState.stackImages];
          chipState.playerStacks[chipState.currentAnalyzingPlayer].estimatedStack = estimatedValue;
          chipState.playerStacks[chipState.currentAnalyzingPlayer].analysis = analysisText;
          
          // UI 업데이트
          renderPlayerChipButtons();
          showAnalysisResults(chipState.currentAnalyzingPlayer, analysisText, estimatedValue);
          
          // 모달 닫기
          closeStackAnalysisModal();
        }
        
      } catch (error) {
        console.error('AI 분석 실패:', error);
        alert('AI 분석에 실패했습니다. 다시 시도해주세요.');
      } finally {
        // 오버레이 숨기기
        document.getElementById('analyzing-overlay').classList.add('hidden');
      }
    }

    // 한국어 숫자 파싱
    function parseKoreanNumber(str) {
      if (!str) return 0;
      
      str = str.replace(/,/g, '');
      let value = parseFloat(str) || 0;
      
      if (str.includes('만')) value *= 10000;
      if (str.includes('천')) value *= 1000;
      
      return Math.floor(value);
    }

    // 분석 결과 표시
    function showAnalysisResults(playerName, analysisText, estimatedValue) {
      const resultsDiv = document.getElementById('analysis-results');
      const content = document.getElementById('results-content');
      
      resultsDiv.classList.remove('hidden');
      
      content.innerHTML = `
        <div class="bg-gray-700 p-3 rounded-lg">
          <h3 class="font-bold text-amber-400 mb-2">${playerName}</h3>
          <div class="text-2xl font-bold text-green-400 mb-2">
            추정 칩: ${estimatedValue.toLocaleString()}
          </div>
          <div class="text-sm text-gray-300 whitespace-pre-line">
            ${analysisText}
          </div>
        </div>
      `;
    }

    // 스택 분석 모달 닫기
    function closeStackAnalysisModal() {
      const modal = document.getElementById('stack-analysis-modal');
      const video = document.getElementById('stack-video');
      
      if (video.srcObject) {
        video.srcObject.getTracks().forEach(track => track.stop());
      }
      
      modal.classList.add('hidden');
      chipState.currentAnalyzingPlayer = null;
      chipState.stackImages = [];
    }

    // 칩 컬러 저장
    function saveChipColors() {
      localStorage.setItem('pokerChipColors', JSON.stringify(chipState.chipColors));
    }

    // 저장된 칩 컬러 로드
    function loadSavedChipColors() {
      const saved = localStorage.getItem('pokerChipColors');
      if (saved) {
        try {
          chipState.chipColors = JSON.parse(saved);
          renderChipColorSlots();
        } catch (e) {
          console.error('칩 컬러 로드 실패:', e);
        }
      }
    }

    // 이벤트 리스너 설정
    function setupEventListeners() {
      // 칩 추가 버튼
      document.getElementById('add-chip-color-btn').addEventListener('click', () => {
        if (chipState.chipColors.length < chipState.maxChips) {
          const emptySlot = chipState.chipColors.length;
          selectChipSlot(emptySlot);
        } else {
          alert('최대 5개까지만 등록 가능합니다.');
        }
      });
      
      // 칩 촬영 버튼
      document.getElementById('capture-chip-btn').addEventListener('click', captureChipPhoto);
      document.getElementById('close-chip-modal').addEventListener('click', closeChipColorModal);
      
      // 스택 촬영 버튼
      document.getElementById('capture-stack-btn').addEventListener('click', captureStackPhoto);
      document.getElementById('analyze-stack-btn').addEventListener('click', analyzeChipStack);
      document.getElementById('close-stack-modal').addEventListener('click', closeStackAnalysisModal);
    }

    // 앱 시작
    document.addEventListener('DOMContentLoaded', initChipAnalyzer);
  </script>
</body>
</html>